{"pageProps":{"frontmatter":{"title":"Deploying Kimi K2 with PD Disaggregation and Large-Scale Expert Parallelism on 128 H200 GPUs","author":"The Mooncake Team","date":"July 20, 2025","previewImg":"/images/blog/k2_large_scale/preview.jpg"},"content":"\n\n## 1️⃣ Introduction: Deploying the Most Advanced Open-Source MoE Model\n\n**Kimi K2 is currently the most advanced open-source Mixture-of-Experts (MoE) model available.**\n\nReleased by Moonshot AI in 2025, it features:\n\n- **1 trillion total parameters**\n- **32 billion activated parameters per token**\n- **384 experts with dynamic routing**\n- **Multi-head Latent Attention (MLA)** for long context support\n\nKimi K2 achieves strong performance in **frontier knowledge, math, and coding**, and is optimized for **agentic tasks**—not just answering questions but taking multi-step actions.\n\nMoonshot AI open-sourced two versions:\n\n- **Kimi-K2-Base**: The foundation model for research and fine-tuning\n- **Kimi-K2-Instruct**: A post-trained model for general-purpose chat and agentic applications\n\nFor more details, please refer to the [official Kimi K2 release](https://moonshotai.github.io/Kimi-K2/).\n\n---\n\n### Why Large-Scale Deployment Matters\n\nLarge-scale deployment fully leverages hardware capabilities and reduces costs given the model’s architecture.\n\n- **Serve More Requests, Faster:** Higher throughput, lower latency, more concurrent sessions, and shorter queues.\n- **Lower $/Token:** Saturate hardware and amortize model load; efficiency improves at scale.\n\nHowever, the large-scale deployment of trillion-scale MoE models present unique challenges:\n\n- **Computational sparsity in MoE layers** necessitates large batch sizes to make matrix operations compute-intensive. Large-scale Expert Parallelism (EP) scales parallelism strategies across more GPUs, aggregates requests from multiple devices, reduces per-GPU memory pressure, and frees up VRAM for larger KV caches—effectively increasing batch size.\n- **Cross-node** communication takes a large amount of time and requires optimizations\n- **Sparse expert activation** leads to load imbalance\n\nEfficient deployment of Kimi K2 on **128 H200 GPUs** requires rethinking both system design and deployment workflows.\n\nIn this blog, we explain how we solved this problem using **OME** and **SGLang**.\n\n---\n\n## 2️⃣ Background: From DeepSeek R1 to Kimi K2\n\nIn May 2025, we published [Deploying DeepSeek R1 with PD Disaggregation and Large-Scale EP](https://lmsys.org/blog/2025-05-05-large-scale-ep/), where we demonstrated:\n\n- **Prefill-Decode (PD) Disaggregation** to separate compute-heavy and latency-sensitive tasks\n- **Large-Scale Expert Parallelism (EP)** to handle MoE routing across 96 GPUs\n- **5× throughput improvement** compared to vanilla tensor parallelism on H100s\n\nAt the same time, our [OME blog](https://lmsys.org/blog/2025-07-08-ome/) introduced **model-driven deployment**, solving the operational gap between:\n\n- **ML Engineers**, who design complex serving strategies\n- **Production Engineers**, who need simple and reliable deployments\n\nThe OME insight—the model should drive deployment, not vice-versa—proved productive for scaling to Kimi K2’s 1T-parameter architecture. This transition required adapting DeepSeek’s PD Disaggregation and EP to Kimi K2’s 384 experts while maintaining high performance.\n\n---\n\n## 3️⃣ Our Solution: OME + SGLang PD Disaggregation + Large-Scale Expert Parallelism\n\nFor Kimi K2, we combined the strengths of **OME** and **SGLang** to create an optimized, scalable deployment pipeline.\n\n### Model-Driven Deployment with OME\n\nOME (Open Model Engine) simplifies the deployment of advanced models like Kimi K2 by abstracting away the complexity of parallelism, sharding, scaling, and runtime configuration. With a declarative configuration model, OME enables production teams to deploy and manage large models without manual tuning or custom scripting.\n\n**OME Installation**\n\nInstall OME directly from the OCI registry using the following commands:\n\n```bash\n# Step 1: Install OME CRDs\nhelm upgrade --install ome-crd oci://ghcr.io/moirai-internal/charts/ome-crd --namespace ome --create-namespace\n\n# Step 2: Install OME core resources\nhelm upgrade --install ome oci://ghcr.io/moirai-internal/charts/ome-resources --namespace ome\n```\n\nFor detailed setup instructions, refer to the official [OME installation guide](https://docs.sglang.ai/ome/docs/installation/).\n\n**Registering the Kimi K2 Model**\nTo enable OME to manage the Kimi K2 model family, apply the following ClusterBaseModel resource:\n\n```bash\nkubectl apply -f https://raw.githubusercontent.com/sgl-project/ome/refs/heads/main/config/models/moonshotai/Kimi-K2-Instruct.yaml\n```\n\nNote: You may download the YAML file and customize the path field to specify where the model should be stored locally. OME will download the model directly from Hugging Face with optimized parallelism and automatically verify the artifact checksum to ensure integrity.\n\n**Installing the Kimi K2 latest SGLang Serving Runtime**\n\n```bash\nkubectl apply -f https://raw.githubusercontent.com/sgl-project/ome/refs/heads/main/config/runtimes/srt/kimi-k2-pd-rt.yaml\n```\n\n**Deploying the Model**\n\nOnce the model and runtime are registered, deploy the inference endpoint using:\n\n```bash\nkubectl apply -f https://raw.githubusercontent.com/sgl-project/ome/refs/heads/main/config/samples/isvc/moonshotai/kimi-k2-pd.yaml\n```\n\nWith these declarative resources in place, OME will automatically handle model downloading, runtime orchestration, and endpoint provisioning—enabling scalable, production-grade inference for the Kimi K2 model family.\n\n**Interacting with the Model**\n\nThis command forwards local port 8080 to model on port 80:\n```bash\nkubectl port-forward -n kimi-k2-instruct service/kimi-k2-instruct 8080:80\n```\nLeave this running in one terminal. It will route your local http://localhost:8080 to the SGlang router. After the port-forward is active, run this in a second terminal:\n```bash\ncurl -s -X POST http://localhost:8080/generate \\\n  -H 'Content-Type: application/json' \\\n  -H 'Authorization: Bearer None' \\\n  -d '{\n    \"text\": \"The future of AI is\",\n    \"max_new_tokens\": 50,\n    \"temperature\": 0.7\n  }'\n```\n\n---\n\n### **OME Advantages & PD + DeepEP + Router Insights**\n\nOME (Open Model Engine) offers a declarative, production-ready framework for deploying large models like Kimi K2. It abstracts the complexities of GPU topology, distributed configuration, and runtime tuning—eliminating the need for custom orchestration logic. With a single ClusterServingRuntime definition, teams can launch optimized multi-node inference workloads at scale.\n\nThis configuration demonstrates a powerful setup leveraging **Prefill-Decode (PD) disaggregation** and **Large Scale EP**, enabling:\n\n- **Disaggregated scaling** of prefill and decode workloads with independent resource control\n- **Low-latency decode** via deepep-mode=low_latency and token-aware dispatch tuning\n- **Advanced expert routing** with ep-dispatch-algorithm=dynamic and enable-eplb\n- **RDMA acceleration for high-throughput kv-cache transfer**\n\nThe deployment is orchestrated by a lightweight **SGLang Router**, which provides:\n\n- **Dynamic service discovery** for prefill and decode nodes via label selectors\n- **Auto-scaling capabilities** independent of engine and decoder workloads\n- **Least-privilege routing model**—ideal for secure production environments\n- **Optimized load balancing** tailored for disaggregated serving patterns\n\nTogether, OME and the SGLang Router form a robust foundation for large-scale, low-latency, and maintainable inference infrastructure.\n\n### Prefill-Decode Disaggregation\n\nWe separate inference into two independent components:\n\n| Stage | Role |\n| --- | --- |\n| **Prefill** | Handles large prompt ingestion (e.g., 2000-token inputs). This is compute-bound and benefits from large batch parallelism. |\n| **Decode** | Handles autoregressive generation (e.g., 100-token outputs). This is latency-sensitive and optimized for high-throughput outputs. |\n\nPrefill and Decode are deployed as independent services, each scaled and optimized separately.\n\n---\n\n### Large-Scale Expert Parallelism (EP)\n\nKimi K2 activates a subset of **384 experts** per token. We implemented:\n\n- **96 redundant experts on decode nodes** to balance MoE routing\n- **NUMA-aware GPU grouping** for optimal NVLink and PCIe utilization on H200 clusters\n\nThis design minimizes load imbalance and ensures even GPU utilization across the 128-card cluster.\n\n---\n\n## 4️⃣ Performance: 2000-Input, 100-Output Benchmark\n\nWe benchmarked Kimi K2 using a typical LLM serving workload on **128 H200 GPUs with 1P1D (4 nodes/P and 12 nodes/D)**:\n\n| Metric | Value |\n| --- | --- |\n| **Input Length** | 2000 tokens |\n| **Output Length** | 100 tokens |\n| **Decode Batch Size** | 480 |\n\nWe use the same benchmark setup as in the DeepSeek R1 deployment blog as an example. Longer output for agentic scenarios will be future work.\n\nNote: The prefill-to-decode ratio is workload-dependent. We prioritized decode nodes to maximize the KV Cache pool size, which is critical for scaling batch size to 480.\n\n---\n\n### Cluster-Level Performance (128 × H200 GPUs)\n\n| Metric | Value |\n| --- | --- |\n| **Prefill Throughput** | **896k tokens/sec** |\n| **Decode Throughput** | **384k tokens/sec** |\n| **Cost per 1M Output Tokens** | **~$0.21**(**H200 $2.3/hour**) |\n\n---\n\n### Comparison to DeepSeek R1 Deployment\n\n| Model | Experts | GPUs | Prefill Throughput (tokens/sec) | Decode Throughput (tokens/sec) |\n| --- | --- | --- | --- | --- |\n| **DeepSeek R1** | 256 | 96 × H100 | 52.3k / node | 22.3k / node |\n| **Kimi K2** | 384 | 128 × H200 | 56k / node | 24k / node |\n\nDespite Kimi K2’s larger MoE and more complex routing, our deployment achieves:\n\n- **Balanced expert activation**, using expert-parallel load balancer (EPLB)\n- **High throughput per GPU** by applying SGLang’s specific optimizations for DeepSeek V3 architecture to H200\n\nThe next step involves evaluating and optimizing long-context scenarios. As K2 is a model designed for agentic tasks, it has been reported that the average input length in such scenarios can range from 30,000 to 50,000 tokens.\n\n---\n\n## 5️⃣ Conclusion: Trillion-Scale Inference at Scale\n\nBy combining **OME**, **SGLang**, **PD Disaggregation**, and **Large-Scale Expert Parallelism**, we deployed Kimi K2 on **128 H200 GPUs**, achieving:\n\n- **Cost-effective large-scale inference** (~$0.21 per 1M output tokens on H200) is available for short-context scenarios, with ongoing efforts to optimize the long-context scenarios.\n- **Simplified deployment workflows** with model-driven configuration\n\nAll components of this deployment are **fully open-source and reproducible**. We welcome the community to build on this work.\n\nThis deployment was made possible not only by open collaboration between Mooncake and the SGLang community, but also through the generous infrastructure support from NVIDIA DGX Cloud. NVIDIA provided the SGLang team with access to 128 H200 GPUs via DGX Cloud, enabling us to accelerate the deployment of Kimi K2 from model release to production-grade inference very quickly. As a result, organizations can now leverage SGLang to serve Kimi K2 at scale, unlocking advanced reasoning capabilities with state-of-the-art performance.\n\n---\n\n### Acknowledgments\n\nWe would like to express our heartfelt gratitude to the following teams and collaborators:\n\n- **Mooncake Team:** Boxin Zhang, Shangming Cai, Mingxing Zhang, and colleagues.\n- **SGLang Team and community:** Simo Lin, Jingyi Chen, Qiaolin Yu, Yanbo Yang, Yineng Zhang, and many others.\n\nWe extend our thanks to the **MoonshotAI Team**—including Shaowei Liu, Zhengtao Wang, Weiran He, Xinran Xu, and others—for their support in tuning the big beautiful model K2.\n\n---\n\n## Further Reading\n\n- [Deploying DeepSeek R1 with PD Disaggregation and Large-Scale EP](https://lmsys.org/blog/2025-05-05-large-scale-ep/)\n- [OME: Model-Driven LLM Deployment](https://lmsys.org/blog/2025-07-08-ome/)\n- [Kimi K2 Official Release](https://moonshotai.github.io/Kimi-K2/)\n- [SGLang GitHub Repository](https://github.com/sgl-project/sglang)\n","slug":"2025-07-20-k2-large-scale-ep"},"__N_SSG":true}